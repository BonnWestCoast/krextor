#!/bin/bash
# 
# krextor: runs the Krextor XML->RDF extractor
# 
# Copyright (C) 2008
# Christoph Lange
# KWARC, Jacobs University Bremen
# http://kwarc.info/projects/krextor/
#
#  Krextor is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public
#  License as published by the Free Software Foundation; either
#  version 2 of the License, or (at your option) any later version.
#  
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#  Lesser General Public License for more details.
#  
#  You should have received a copy of the GNU Lesser General Public
#  License along with this library; if not, write to the
#  Free Software Foundation, Inc., 59 Temple Place - Suite 330,
#  Boston, MA 02111-1307, USA.

function help {
cat <<EOF
Syntax: krextor IN..OUT FILE
Extracts RDF from the XML document FILE.  IN specifies the format of FILE; OUT
specifies the desired RDF serialization.

  -h, --help	Show this help
EOF
}

if [[ $# -lt 2 ]]
then
    help
    if [[ $1 == "h" || $1 == "--help" ]]
    then
	exit 0
    else
	exit 1
    fi
fi

format=$1
infile=$2

xml=${format%%..*}
rdf=${format##*..}

if [[ -z $xml || -z $rdf ]]
then
    help
    exit 2
fi

KREXTOR_BIN="$(which $0)"
if [[ -z "$KREXTOR_BIN" ]]
then
    KREXTOR_BIN="$0"
fi
while [[ -L "$KREXTOR_BIN" ]]
do
    KREXTOR_BIN="$(readlink -f $KREXTOR_BIN)"
done
KREXTOR_HOME="$(dirname "$KREXTOR_BIN")"
KREXTOR_HOME="$(cd "$KREXTOR_HOME/.." ; pwd)"

transformer="$KREXTOR_HOME/src/xslt/transform-${xml}..${rdf}.xsl"

if [[ ! -r $transformer ]]
then
    xmlExtractor=$KREXTOR_HOME/src/xslt/extract/$xml.xsl
    rdfOutput=$KREXTOR_HOME/src/xslt/output/$rdf.xsl

    if [[ ! -e $xmlExtractor ]]
    then
	echo "no extraction module found for $xml format"
	exit 3
    fi

    if [[ ! -e $rdfOutput ]]
    then
	echo "no output module found for $rdf serialization"
	exit 4
    fi

    cat > /tmp/krextor.$$.xsl <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!-- Template extracting $rdf from $xml, generated by Krextor -->
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    version="2.0">
    <xsl:import href="$rdfOutput"/>
    <xsl:include href="$xmlExtractor"/>
</xsl:stylesheet>
EOF
    transformer=/tmp/krextor.$$.xsl
fi

java -jar ${SAXON_JAR:-$KREXTOR_HOME/lib/saxon/saxon9.jar} $infile $transformer

[[ -e /tmp/krextor.$$.xsl ]] && rm /tmp/krextor.$$.xsl

exit 0

